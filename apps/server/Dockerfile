# syntax=docker/dockerfile:1.7
# This file is generated by Dofigen v2.0.0
# See https://github.com/lenra-io/dofigen

# install
FROM oven/bun@sha256:eb409bed239c3adff079a6b71283f151e802d66b99f643ba7a71e1be7d3da513 AS install
WORKDIR /app/apps/server
COPY \
    --link \
    "." "/app/"
USER 0:0
RUN \
    --mount=type=cache,target=/root/.bun/install/cache,uid=0,gid=0,sharing=locked \
    bun install --ignore-scripts --frozen-lockfile

# build
FROM install AS build
USER 0:0
RUN bun build --compile --sourcemap src/index.ts --outfile=app

# runtime
FROM debian@sha256:00558f781b91e90469812bad32002f311ab26ef241b4a1996f6600680ec82f5c AS runtime
COPY \
    --from=build \
    --chown=1000:1000 \
    --chmod=555 \
    --link \
    "/app/apps/server/app" "/bin/"
USER 1000:1000
EXPOSE 3000
ENTRYPOINT ["/bin/app"]
